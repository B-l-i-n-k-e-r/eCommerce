<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BokinceX | Cart</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
        #cart-table button.remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
        }
        #cart-table button.remove-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>

    <header class="navbar">
        <div class="logo">BokinceX</div>
        <input type="text" placeholder="Search products..." class="search-bar" disabled />
        <div class="nav-links">
            </div>
    </header>

    <table id="cart-table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Qty</th>
                <th>Total</th>
                <th>Remove</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5" style="text-align:center;">Loading cart...</td></tr>
        </tbody>
    </table>

    <div class="cart-actions">
        <a href="index.html" class="cart-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M7 4h-2l-3 9v2h2a3 3 0 1 0 6 0h6a3 3 0 1 0 6 0h2v-2l-3-9h-2l-3 9h-8l-3-9zm2 13a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm10 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
            </svg>
            Continue Shopping
        </a>

        <span id="cart-total">Total: $0.00</span>

        <a href="checkout.html" class="cart-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M2 4a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v4h-20v-4zm0 6h20v10a2 2 0 0 1-2 2h-16a2 2 0 0 1-2-2v-10zm4 3a1 1 0 1 0 0 2h4a1 1 0 1 0 0-2h-4z"/>
            </svg>
            Proceed to Checkout
        </a>
    </div>

    <script>
        const navLinks = document.querySelector('.nav-links');
        const tbody = document.querySelector('#cart-table tbody');
        const totalEl = document.getElementById('cart-total');
        let cart = [];

        function updateNavbar(user, cartCount) {
            navLinks.innerHTML = '';
            if (user) {
                navLinks.innerHTML = `
                    <a href="cart.html">ðŸ›’ Cart (${cartCount})</a>
                    <span style="margin-left:10px;">ðŸ‘‹ Welcome, ${user.username}</span>
                    <a href="#" id="logout-btn">ðŸšª Logout</a>
                `;
                document.getElementById("logout-btn").onclick = () => {
                    fetch("http://localhost/ecommerce-php/api/logout.php")
                        .then(() => location.reload());
                };
            } else {
                window.location.href = "login.html"; // Redirect to login if not authenticated
            }
        }

        // Step 1: Session Check and Fetch Cart Items
        fetch('http://localhost/ecommerce-php/api/session.php')
            .then(res => res.json())
            .then(user => {
                if (!user.logged_in) {
                    window.location.href = "login.html";
                } else {
                    updateNavbar({ username: user.username });
                    fetch('http://localhost/ecommerce-php/api/cart.php')
                        .then(res => res.json())
                        .then(data => {
                            cart = data;
                            updateCartDisplay();
                            updateNavbar({ username: user.username }, cart.length);
                        })
                        .catch(() => {
                            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Failed to load cart.</td></tr>`;
                            updateNavbar({ username: user.username }, 0);
                        });
                }
            });

        // Step 3: Update Table Display
        function updateCartDisplay() {
            tbody.innerHTML = "";
            let total = 0;

            if (cart.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">ðŸ›’ Your cart is empty.</td></tr>`;
                totalEl.textContent = "Total: $0.00";
                return;
            }

            cart.forEach((item) => {
                const itemTotal = parseFloat(item.price) * parseInt(item.quantity);
                total += itemTotal;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.product_name}</td>
                    <td>$${parseFloat(item.price).toFixed(2)}</td>
                    <td>${item.quantity}</td>
                    <td>$${itemTotal.toFixed(2)}</td>
                    <td>
                        <button data-id="${item.product_id}" class="remove-btn" aria-label="Remove ${item.product_name}">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            totalEl.textContent = `Total: $${total.toFixed(2)}`;
        }

        // Step 4: Remove Item
        tbody.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-btn')) {
                const productId = e.target.dataset.id;

                fetch('http://localhost/ecommerce-php/api/cart.php', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: productId })
                })
                .then(res => res.json())
                .then(updatedCart => {
                    cart = updatedCart;
                    updateCartDisplay();
                    // Update cart count in navbar after removal
                    fetch('http://localhost/ecommerce-php/api/cart.php')
                        .then(res => res.json())
                        .then(latestCart => {
                            updateNavbar({ username: localStorage.getItem('username') }, latestCart.length);
                        })
                        .catch(err => console.error("Error updating cart count:", err));
                });
            }
        });

        // Attempt to retrieve username from localStorage (set on login)
        const storedUsername = localStorage.getItem('username');
        if (storedUsername) {
            updateNavbar({ username: storedUsername }, cart.length); // Initial update with stored username
        }
    </script>

    <footer class="footer">
        <p>Â© 2025 BokinceX. All rights reserved.</p>
    </footer>

</body>
</html>